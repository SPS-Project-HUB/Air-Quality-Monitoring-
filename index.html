<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESP32 Air Quality — Live Dashboard</title>
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-light: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .header-left h1 {
      margin: 0 0 4px 0;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text);
    }

    .header-left .subtitle {
      color: var(--text-light);
      font-size: 0.95rem;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--card-bg);
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      box-shadow: var(--shadow);
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .status-indicator.connected {
      background: var(--secondary);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 20px;
    }

    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .card-title {
      margin: 0 0 16px 0;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 16px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align: center;
      border-left: 4px solid var(--primary);
    }

    .stat-card.temp {
      border-left-color: #ef4444;
    }

    .stat-card.humidity {
      border-left-color: #3b82f6;
    }

    .stat-card.pressure {
      border-left-color: #10b981;
    }

    .stat-card.gas {
      border-left-color: #f59e0b;
    }

    .stat-card h3 {
      margin: 0 0 8px 0;
      font-size: 0.9rem;
      color: var(--text-light);
      font-weight: 500;
    }

    .stat-card .value {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
    }

    .stat-card .unit {
      font-size: 0.9rem;
      color: var(--text-light);
      font-weight: 500;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    th {
      font-weight: 600;
      color: var(--text-light);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .scroll-container {
      max-height: 320px;
      overflow: auto;
      border-radius: 8px;
    }

    .scroll-container::-webkit-scrollbar {
      width: 6px;
    }

    .scroll-container::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }

    .scroll-container::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    /* UPDATED TRENDS SECTION STYLES */
    .trends-section {
      margin-top: 20px;
    }
    
    .trends-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .trends-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text);
      margin: 0;
    }
    
    .trends-subtitle {
      color: var(--text-light);
      font-size: 0.9rem;
      margin: 4px 0 0 0;
    }
    
    .trends-controls {
      display: flex;
      gap: 12px;
    }
    
    .timeframe-btn {
      padding: 6px 12px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.85rem;
      color: var(--text-light);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .timeframe-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .trends-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    
    @media (max-width: 1024px) {
      .trends-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .trend-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .trend-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 20px -4px rgba(0, 0, 0, 0.1);
    }
    
    .trend-card-header {
      padding: 16px 20px 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .trend-card-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }
    
    .trend-card-value {
      font-size: 1.1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .trend-card-value .unit {
      font-size: 0.8rem;
      color: var(--text-light);
      font-weight: 500;
    }
    
    .trend-change {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
      font-weight: 500;
      padding: 2px 6px;
      border-radius: 10px;
      background: #f1f5f9;
    }
    
    .trend-change.positive {
      color: #10b981;
      background: #d1fae5;
    }
    
    .trend-change.negative {
      color: #ef4444;
      background: #fee2e2;
    }
    
    .trend-card-body {
      padding: 0;
      height: 200px;
      position: relative;
    }
    
    .trend-card-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--text-light);
    }
    
    .trend-minmax {
      display: flex;
      gap: 12px;
    }
    
    .minmax-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .minmax-label {
      font-weight: 500;
    }
    
    .info-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .info-list li {
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .info-list li:last-child {
      border-bottom: none;
    }

    .info-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #dbeafe;
      border-radius: 50%;
      color: var(--primary);
      font-size: 0.8rem;
      font-weight: bold;
    }

    footer {
      margin-top: 30px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      text-align: center;
      color: var(--text-light);
      font-size: 0.85rem;
    }

    .muted {
      color: var(--text-muted);
    }

    .last-updated {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .empty-state {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-light);
    }

    .empty-state p {
      margin: 8px 0 0 0;
    }
  </style>
  <!-- Chart.js (for charts) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-left">
        <h1>ESP32 Air Quality Dashboard</h1>
        <div class="subtitle">Real-time monitoring from Firebase Realtime Database</div>
      </div>
      <div class="status-badge">
        <div class="status-indicator" id="status-indicator"></div>
        <span id="status-text">Connecting...</span>
      </div>
    </header>

    <div class="grid">
      <!-- Left: main content -->
      <div>
        <div class="card">
          <div class="card-title">
            <span>Current Readings</span>
            <div class="last-updated" id="latest-time">Last updated: —</div>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card temp">
              <h3>Temperature (DHT)</h3>
              <p class="value" id="temp-dht">—</p>
              <span class="unit">°C</span>
            </div>
            <div class="stat-card humidity">
              <h3>Humidity</h3>
              <p class="value" id="hum">—</p>
              <span class="unit">%</span>
            </div>
            <div class="stat-card pressure">
              <h3>Pressure (BMP)</h3>
              <p class="value" id="pres">—</p>
              <span class="unit">hPa</span>
            </div>
            <div class="stat-card gas">
              <h3>Gas Level</h3>
              <p class="value" id="gas">—</p>
              <span class="unit">ppm</span>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top: 20px;">
          <div class="card-title">
            <span>Recent Data Logs</span>
            <span class="muted" id="entry-count">0 entries</span>
          </div>
          <div class="scroll-container">
            <table>
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Temp (DHT)</th>
                  <th>Humidity</th>
                  <th>Temp (BMP)</th>
                  <th>Pressure</th>
                  <th>Gas</th>
                  <th>Light</th>
                  <th>Rain</th>
                </tr>
              </thead>
              <tbody id="log-table-body">
                <tr>
                  <td colspan="8" class="empty-state">
                    <div>No data available</div>
                    <p>Waiting for sensor readings...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- UPDATED TRENDS SECTION -->
        <div class="trends-section">
          <div class="card">
            <div class="trends-header">
              <div>
                <h2 class="trends-title">Environmental Trends</h2>
                <p class="trends-subtitle">Last 50 readings with change indicators</p>
              </div>
              <div class="trends-controls">
                <button class="timeframe-btn active">1H</button>
                <button class="timeframe-btn">6H</button>
                <button class="timeframe-btn">24H</button>
              </div>
            </div>
            
            <div class="trends-grid">
              <!-- Temperature Trend Card -->
              <div class="trend-card">
                <div class="trend-card-header">
                  <h3 class="trend-card-title">Temperature</h3>
                  <div class="trend-card-value">
                    <span id="current-temp">—</span>
                    <span class="unit">°C</span>
                    <div class="trend-change" id="temp-change">
                      <span>→</span>
                      <span>0.0%</span>
                    </div>
                  </div>
                </div>
                <div class="trend-card-body">
                  <canvas id="chart-temp"></canvas>
                </div>
                <div class="trend-card-footer">
                  <div class="trend-minmax">
                    <div class="minmax-item">
                      <span class="minmax-label">Min:</span>
                      <span id="temp-min">— °C</span>
                    </div>
                    <div class="minmax-item">
                      <span class="minmax-label">Max:</span>
                      <span id="temp-max">— °C</span>
                    </div>
                  </div>
                  <div>DHT Sensor</div>
                </div>
              </div>
              
              <!-- Humidity Trend Card -->
              <div class="trend-card">
                <div class="trend-card-header">
                  <h3 class="trend-card-title">Humidity</h3>
                  <div class="trend-card-value">
                    <span id="current-hum">—</span>
                    <span class="unit">%</span>
                    <div class="trend-change" id="hum-change">
                      <span>→</span>
                      <span>0.0%</span>
                    </div>
                  </div>
                </div>
                <div class="trend-card-body">
                  <canvas id="chart-hum"></canvas>
                </div>
                <div class="trend-card-footer">
                  <div class="trend-minmax">
                    <div class="minmax-item">
                      <span class="minmax-label">Min:</span>
                      <span id="hum-min">— %</span>
                    </div>
                    <div class="minmax-item">
                      <span class="minmax-label">Max:</span>
                      <span id="hum-max">— %</span>
                    </div>
                  </div>
                  <div>DHT Sensor</div>
                </div>
              </div>
              
              <!-- Pressure Trend Card -->
              <div class="trend-card">
                <div class="trend-card-header">
                  <h3 class="trend-card-title">Pressure</h3>
                  <div class="trend-card-value">
                    <span id="current-pres">—</span>
                    <span class="unit">hPa</span>
                    <div class="trend-change" id="pres-change">
                      <span>→</span>
                      <span>0.0%</span>
                    </div>
                  </div>
                </div>
                <div class="trend-card-body">
                  <canvas id="chart-pres"></canvas>
                </div>
                <div class="trend-card-footer">
                  <div class="trend-minmax">
                    <div class="minmax-item">
                      <span class="minmax-label">Min:</span>
                      <span id="pres-min">— hPa</span>
                    </div>
                    <div class="minmax-item">
                      <span class="minmax-label">Max:</span>
                      <span id="pres-max">— hPa</span>
                    </div>
                  </div>
                  <div>BMP Sensor</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: side panel -->
      <aside>
        <div class="card">
          <div class="card-title">Connection Status</div>
          <div class="muted" style="margin-bottom: 8px;">Firebase URL</div>
          <div id="fb-url" class="muted" style="word-break: break-all; margin-bottom: 16px; font-size: 0.85rem;"></div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
            <span class="muted">Database:</span>
            <span id="db-status" style="font-weight: 600;">—</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span class="muted">Last Sync:</span>
            <span id="last-sync" style="font-weight: 600;">—</span>
          </div>
        </div>

        <div class="card" style="margin-top: 20px;">
          <div class="card-title">Quick Guide</div>
          <ul class="info-list">
            <li>
              <div class="info-icon">1</div>
              <div>Push sensor data to <code>/esp32_data_log/</code> from ESP32</div>
            </li>
            <li>
              <div class="info-icon">2</div>
              <div>Dashboard updates automatically in real-time</div>
            </li>
            <li>
              <div class="info-icon">3</div>
              <div>Deploy by hosting on GitHub Pages or similar</div>
            </li>
          </ul>
        </div>

        <div class="card" style="margin-top: 20px;">
          <div class="card-title">Sensor Information</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <div class="muted">DHT Sensor</div>
              <div style="font-weight: 600;">Temp & Humidity</div>
            </div>
            <div>
              <div class="muted">BMP Sensor</div>
              <div style="font-weight: 600;">Pressure & Temp</div>
            </div>
            <div>
              <div class="muted">MQ Sensor</div>
              <div style="font-weight: 600;">Gas Quality</div>
            </div>
            <div>
              <div class="muted">LDR</div>
              <div style="font-weight: 600;">Light Level</div>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <footer>
      <div>Made for ESP32 Air Quality Monitoring • <span class="muted">Real-time data from Firebase</span></div>
    </footer>
  </div>

  <!-- Firebase module SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      query,
      orderByKey,
      limitToLast,
      onValue,
      get
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    // ---------- FIREBASE CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCcFVfrAO-EOEqQcs3oZtJVLTgpF32uyb4",
      authDomain: "air-quality-e5e71.firebaseapp.com",
      databaseURL: "https://air-quality-e5e71-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "air-quality-e5e71",
      storageBucket: "air-quality-e5e71.firebasestorage.app",
      messagingSenderId: "833458600295",
      appId: "1:833458600295:web:99a1c59c0e3f612c73d7c2"
    };
    // -----------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // UI elements
    const fbUrlEl = document.getElementById('fb-url');
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const dbStatusEl = document.getElementById('db-status');
    const lastSyncEl = document.getElementById('last-sync');
    const entryCountEl = document.getElementById('entry-count');
    const latestTimeEl = document.getElementById('latest-time');
    const tempDhtEl = document.getElementById('temp-dht');
    const humEl = document.getElementById('hum');
    const presEl = document.getElementById('pres');
    const gasEl = document.getElementById('gas');
    const logBody = document.getElementById('log-table-body');
    
    // New trend elements
    const currentTempEl = document.getElementById('current-temp');
    const currentHumEl = document.getElementById('current-hum');
    const currentPresEl = document.getElementById('current-pres');
    const tempChangeEl = document.getElementById('temp-change');
    const humChangeEl = document.getElementById('hum-change');
    const presChangeEl = document.getElementById('pres-change');
    const tempMinEl = document.getElementById('temp-min');
    const tempMaxEl = document.getElementById('temp-max');
    const humMinEl = document.getElementById('hum-min');
    const humMaxEl = document.getElementById('hum-max');
    const presMinEl = document.getElementById('pres-min');
    const presMaxEl = document.getElementById('pres-max');

    fbUrlEl.textContent = firebaseConfig.databaseURL || '—';

    // Update connection status
    function updateStatus(status, isConnected) {
      statusText.textContent = status;
      statusIndicator.className = 'status-indicator';
      if (isConnected) {
        statusIndicator.classList.add('connected');
        dbStatusEl.textContent = 'Connected';
        dbStatusEl.style.color = '#10b981';
      } else {
        dbStatusEl.textContent = 'Disconnected';
        dbStatusEl.style.color = '#ef4444';
      }
    }

    // Create gradient for charts
    function createGradient(ctx, color) {
      const gradient = ctx.createLinearGradient(0, 0, 0, 200);
      gradient.addColorStop(0, color + '40');
      gradient.addColorStop(1, color + '05');
      return gradient;
    }

    // chart setups
    const ctxT = document.getElementById('chart-temp').getContext('2d');
    const ctxH = document.getElementById('chart-hum').getContext('2d');
    const ctxP = document.getElementById('chart-pres').getContext('2d');

    function createChartConfig(ctx, color, label) {
      return {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: label,
            data: [],
            borderColor: color,
            backgroundColor: createGradient(ctx, color),
            tension: 0.4,
            pointRadius: 0,
            borderWidth: 2,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { display: false },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(255, 255, 255, 0.9)',
              titleColor: '#1e293b',
              bodyColor: '#475569',
              borderColor: '#e2e8f0',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                title: function(tooltipItems) {
                  return tooltipItems[0].label;
                },
                label: function(context) {
                  return `${label}: ${context.parsed.y}`;
                }
              }
            }
          },
          scales: {
            x: { 
              display: true,
              grid: { display: false },
              ticks: {
                maxTicksLimit: 6,
                color: '#94a3b8',
                font: { size: 10 }
              }
            },
            y: { 
              display: true,
              grid: { 
                color: 'rgba(0,0,0,0.05)',
                drawBorder: false
              },
              ticks: {
                color: '#94a3b8',
                font: { size: 10 }
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'nearest'
          }
        }
      };
    }

    const chartTemp = new Chart(ctxT, createChartConfig(ctxT, '#ef4444', 'Temperature'));
    const chartHum = new Chart(ctxH, createChartConfig(ctxH, '#3b82f6', 'Humidity'));
    const chartPres = new Chart(ctxP, createChartConfig(ctxP, '#10b981', 'Pressure'));

    // helper: convert numeric string key (timestamp ms) to readable time
    function timeFromKey(k) {
      let n = Number(k);
      if (!isFinite(n)) return k;
      const d = new Date(n);
      return d.toLocaleString();
    }

    function formatTimeShort(timestamp) {
      const d = new Date(timestamp);
      return d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    }

    // Keep small rolling arrays
    const MAX_POINTS = 50;
    function pushPoint(chart, label, value) {
      chart.data.labels.push(label);
      chart.data.datasets[0].data.push(value);
      while (chart.data.labels.length > MAX_POINTS) chart.data.labels.shift();
      while (chart.data.datasets[0].data.length > MAX_POINTS) chart.data.datasets[0].data.shift();
      chart.update('none');
    }

    // Calculate trend change
    function calculateChange(data) {
      if (data.length < 2) return 0;
      const current = data[data.length - 1];
      const previous = data[data.length - 2];
      return ((current - previous) / previous) * 100;
    }

    // Update trend indicators
    function updateTrendIndicators(tempData, humData, presData) {
      // Temperature trend
      const tempChange = calculateChange(tempData);
      updateTrendElement(tempChangeEl, tempChange);
      
      // Humidity trend
      const humChange = calculateChange(humData);
      updateTrendElement(humChangeEl, humChange);
      
      // Pressure trend
      const presChange = calculateChange(presData);
      updateTrendElement(presChangeEl, presChange);
    }
    
    function updateTrendElement(element, change) {
      const arrow = element.querySelector('span:first-child');
      const value = element.querySelector('span:last-child');
      
      // Reset classes
      element.className = 'trend-change';
      
      // Set appropriate class and arrow
      if (change > 0) {
        element.classList.add('positive');
        arrow.textContent = '↑';
        value.textContent = `${change.toFixed(1)}%`;
      } else if (change < 0) {
        element.classList.add('negative');
        arrow.textContent = '↓';
        value.textContent = `${Math.abs(change).toFixed(1)}%`;
      } else {
        arrow.textContent = '→';
        value.textContent = '0.0%';
      }
    }
    
    // Update min/max values
    function updateMinMax(tempData, humData, presData) {
      if (tempData.length > 0) {
        const minTemp = Math.min(...tempData).toFixed(1);
        const maxTemp = Math.max(...tempData).toFixed(1);
        tempMinEl.textContent = `${minTemp} °C`;
        tempMaxEl.textContent = `${maxTemp} °C`;
      }
      
      if (humData.length > 0) {
        const minHum = Math.min(...humData).toFixed(1);
        const maxHum = Math.max(...humData).toFixed(1);
        humMinEl.textContent = `${minHum} %`;
        humMaxEl.textContent = `${maxHum} %`;
      }
      
      if (presData.length > 0) {
        const minPres = Math.min(...presData).toFixed(1);
        const maxPres = Math.max(...presData).toFixed(1);
        presMinEl.textContent = `${minPres} hPa`;
        presMaxEl.textContent = `${maxPres} hPa`;
      }
    }

    // Watch the last N entries under /esp32_data_log
    const logRef = query(ref(db, '/esp32_data_log'), orderByKey(), limitToLast(100));
    onValue(logRef, (snapshot) => {
      const data = snapshot.val();
      if (!data) {
        updateStatus('No data available', false);
        return;
      }
      
      updateStatus('Live updating', true);
      lastSyncEl.textContent = new Date().toLocaleTimeString();
      
      // Convert object of keys -> values into array sorted by key (ascending)
      const entries = Object.keys(data).map(k => ({ key:k, v:data[k] })).sort((a,b)=>Number(a.key)-Number(b.key));
      entryCountEl.textContent = `${entries.length} entries`;

      // Clear table body and charts
      logBody.innerHTML = '';
      // reset charts
      chartTemp.data.labels = []; chartTemp.data.datasets[0].data = [];
      chartHum.data.labels = []; chartHum.data.datasets[0].data = [];
      chartPres.data.labels = []; chartPres.data.datasets[0].data = [];

      // Arrays to store values for trend calculations
      const tempValues = [];
      const humValues = [];
      const presValues = [];

      // iterate and build rows (we will display newest first)
      for (let i = entries.length - 1; i >= 0; i--) {
        const e = entries[i];
        const val = e.v || {};
        const ts = val.timestamp_ms ? Number(val.timestamp_ms) : Number(e.key) || Date.now();
        const tr = document.createElement('tr');

        const ttime = new Date(ts).toLocaleTimeString();
        const tdTime = `<td class="small">${ttime}</td>`;
        const tdTempD = `<td>${val.temperature_dht ?? '—'}</td>`;
        const tdHum   = `<td>${val.humidity ?? '—'}</td>`;
        const tdTempB = `<td>${val.temperature_bmp ?? '—'}</td>`;
        const tdPres  = `<td>${val.pressure ?? '—'}</td>`;
        const tdGas   = `<td>${val.mq_sensor ?? '—'}</td>`;
        const tdLdr   = `<td>${val.ldr_value ?? '—'}</td>`;
        const tdRain  = `<td>${val.rain_value ?? '—'}</td>`;

        tr.innerHTML = tdTime + tdTempD + tdHum + tdTempB + tdPres + tdGas + tdLdr + tdRain;
        logBody.appendChild(tr);
      }

      // latest entry = last element in entries
      const latest = entries[entries.length - 1].v;
      const latestTime = new Date(Number(entries[entries.length - 1].key));
      latestTimeEl.textContent = `Last updated: ${latestTime.toLocaleTimeString()}`;
      
      tempDhtEl.textContent = (latest.temperature_dht !== undefined) ? latest.temperature_dht : '—';
      humEl.textContent = (latest.humidity !== undefined) ? latest.humidity : '—';
      presEl.textContent = (latest.pressure !== undefined) ? latest.pressure : '—';
      gasEl.textContent = (latest.mq_sensor !== undefined) ? latest.mq_sensor : '—';
      
      // Update current values in trend cards
      currentTempEl.textContent = (latest.temperature_dht !== undefined) ? latest.temperature_dht : '—';
      currentHumEl.textContent = (latest.humidity !== undefined) ? latest.humidity : '—';
      currentPresEl.textContent = (latest.pressure !== undefined) ? latest.pressure : '—';

      // Fill charts with ascending order and collect values
      for (let i = 0; i < entries.length; i++) {
        const e = entries[i];
        const val = e.v || {};
        const ts = e.key;
        const label = formatTimeShort(Number(ts));
        
        if (val.temperature_dht !== undefined) {
          const tempVal = Number(val.temperature_dht);
          pushPoint(chartTemp, label, tempVal);
          tempValues.push(tempVal);
        }
        
        if (val.humidity !== undefined) {
          const humVal = Number(val.humidity);
          pushPoint(chartHum, label, humVal);
          humValues.push(humVal);
        }
        
        if (val.pressure !== undefined) {
          const presVal = Number(val.pressure);
          pushPoint(chartPres, label, presVal);
          presValues.push(presVal);
        }
      }
      
      // Update trend indicators and min/max values
      updateTrendIndicators(tempValues, humValues, presValues);
      updateMinMax(tempValues, humValues, presValues);
    }, (err) => {
      updateStatus('Connection error', false);
      console.error('Firebase error:', err);
    });

    // Initial fetch to show status
    (async () => {
      try {
        const snap = await get(ref(db, '/esp32_data_log'));
        if (!snap.exists()) {
          updateStatus('No data yet', false);
        }
      } catch(e) {
        updateStatus('Connection failed', false);
      }
    })();
    
    // Timeframe buttons functionality
    document.querySelectorAll('.timeframe-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        // In a real implementation, you would change the data range here
      });
    });
  </script>
</body>
</html>

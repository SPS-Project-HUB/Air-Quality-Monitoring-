<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESP32 Air Quality — Live Dashboard</title>
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-light: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .header-left h1 {
      margin: 0 0 4px 0;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text);
    }

    .header-left .subtitle {
      color: var(--text-light);
      font-size: 0.95rem;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--card-bg);
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      box-shadow: var(--shadow);
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .status-indicator.connected {
      background: var(--secondary);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 20px;
    }

    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    .card-title {
      margin: 0 0 16px 0;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 16px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align: center;
      border-left: 4px solid var(--primary);
    }

    .stat-card.temp {
      border-left-color: #ef4444;
    }

    .stat-card.humidity {
      border-left-color: #3b82f6;
    }

    .stat-card.pressure {
      border-left-color: #10b981;
    }

    .stat-card.gas {
      border-left-color: #f59e0b;
    }

    .stat-card h3 {
      margin: 0 0 8px 0;
      font-size: 0.9rem;
      color: var(--text-light);
      font-weight: 500;
    }

    .stat-card .value {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
    }

    .stat-card .unit {
      font-size: 0.9rem;
      color: var(--text-light);
      font-weight: 500;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    th {
      font-weight: 600;
      color: var(--text-light);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .scroll-container {
      max-height: 320px;
      overflow: auto;
      border-radius: 8px;
    }

    .scroll-container::-webkit-scrollbar {
      width: 6px;
    }

    .scroll-container::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }

    .scroll-container::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
    }

    .chart-container {
      background: var(--card-bg);
      padding: 16px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .chart-container h4 {
      margin: 0 0 12px 0;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text);
    }

    canvas {
      max-width: 100%;
      height: 160px;
    }

    .info-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .info-list li {
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .info-list li:last-child {
      border-bottom: none;
    }

    .info-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #dbeafe;
      border-radius: 50%;
      color: var(--primary);
      font-size: 0.8rem;
      font-weight: bold;
    }

    footer {
      margin-top: 30px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      text-align: center;
      color: var(--text-light);
      font-size: 0.85rem;
    }

    .muted {
      color: var(--text-muted);
    }

    .last-updated {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .empty-state {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-light);
    }

    .empty-state p {
      margin: 8px 0 0 0;
    }
  </style>
  <!-- Chart.js (for charts) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-left">
        <h1>ESP32 Air Quality Dashboard</h1>
        <div class="subtitle">Real-time monitoring from Firebase Realtime Database</div>
      </div>
      <div class="status-badge">
        <div class="status-indicator" id="status-indicator"></div>
        <span id="status-text">Connecting...</span>
      </div>
    </header>

    <div class="grid">
      <!-- Left: main content -->
      <div>
        <div class="card">
          <div class="card-title">
            <span>Current Readings</span>
            <div class="last-updated" id="latest-time">Last updated: —</div>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card temp">
              <h3>Temperature (DHT)</h3>
              <p class="value" id="temp-dht">—</p>
              <span class="unit">°C</span>
            </div>
            <div class="stat-card humidity">
              <h3>Humidity</h3>
              <p class="value" id="hum">—</p>
              <span class="unit">%</span>
            </div>
            <div class="stat-card pressure">
              <h3>Pressure (BMP)</h3>
              <p class="value" id="pres">—</p>
              <span class="unit">hPa</span>
            </div>
            <div class="stat-card gas">
              <h3>Gas Level</h3>
              <p class="value" id="gas">—</p>
              <span class="unit">ppm</span>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top: 20px;">
          <div class="card-title">
            <span>Recent Data Logs</span>
            <span class="muted" id="entry-count">0 entries</span>
          </div>
          <div class="scroll-container">
            <table>
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Temp (DHT)</th>
                  <th>Humidity</th>
                  <th>Temp (BMP)</th>
                  <th>Pressure</th>
                  <th>Gas</th>
                  <th>Light</th>
                  <th>Rain</th>
                </tr>
              </thead>
              <tbody id="log-table-body">
                <tr>
                  <td colspan="8" class="empty-state">
                    <div>No data available</div>
                    <p>Waiting for sensor readings...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top: 20px;">
          <div class="card-title">Trends (Last 50 Readings)</div>
          <div class="charts-grid">
            <div class="chart-container">
              <h4>Temperature (°C)</h4>
              <canvas id="chart-temp"></canvas>
            </div>
            <div class="chart-container">
              <h4>Humidity (%)</h4>
              <canvas id="chart-hum"></canvas>
            </div>
            <div class="chart-container">
              <h4>Pressure (hPa)</h4>
              <canvas id="chart-pres"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: side panel -->
      <aside>
        <div class="card">
          <div class="card-title">Connection Status</div>
          <div class="muted" style="margin-bottom: 8px;">Firebase URL</div>
          <div id="fb-url" class="muted" style="word-break: break-all; margin-bottom: 16px; font-size: 0.85rem;"></div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
            <span class="muted">Database:</span>
            <span id="db-status" style="font-weight: 600;">—</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span class="muted">Last Sync:</span>
            <span id="last-sync" style="font-weight: 600;">—</span>
          </div>
        </div>

        <div class="card" style="margin-top: 20px;">
          <div class="card-title">Quick Guide</div>
          <ul class="info-list">
            <li>
              <div class="info-icon">1</div>
              <div>Push sensor data to <code>/esp32_data_log/</code> from ESP32</div>
            </li>
            <li>
              <div class="info-icon">2</div>
              <div>Dashboard updates automatically in real-time</div>
            </li>
            <li>
              <div class="info-icon">3</div>
              <div>Deploy by hosting on GitHub Pages or similar</div>
            </li>
          </ul>
        </div>

        <div class="card" style="margin-top: 20px;">
          <div class="card-title">Sensor Information</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <div class="muted">DHT Sensor</div>
              <div style="font-weight: 600;">Temp & Humidity</div>
            </div>
            <div>
              <div class="muted">BMP Sensor</div>
              <div style="font-weight: 600;">Pressure & Temp</div>
            </div>
            <div>
              <div class="muted">MQ Sensor</div>
              <div style="font-weight: 600;">Gas Quality</div>
            </div>
            <div>
              <div class="muted">LDR</div>
              <div style="font-weight: 600;">Light Level</div>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <footer>
      <div>Made for ESP32 Air Quality Monitoring • <span class="muted">Real-time data from Firebase</span></div>
    </footer>
  </div>

  <!-- Firebase module SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      query,
      orderByKey,
      limitToLast,
      onValue,
      get
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    // ---------- FIREBASE CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCcFVfrAO-EOEqQcs3oZtJVLTgpF32uyb4",
      authDomain: "air-quality-e5e71.firebaseapp.com",
      databaseURL: "https://air-quality-e5e71-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "air-quality-e5e71",
      storageBucket: "air-quality-e5e71.firebasestorage.app",
      messagingSenderId: "833458600295",
      appId: "1:833458600295:web:99a1c59c0e3f612c73d7c2"
    };
    // -----------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // UI elements
    const fbUrlEl = document.getElementById('fb-url');
    const statusIndicator = document.getElementById('status-indicator');
    const statusText = document.getElementById('status-text');
    const dbStatusEl = document.getElementById('db-status');
    const lastSyncEl = document.getElementById('last-sync');
    const entryCountEl = document.getElementById('entry-count');
    const latestTimeEl = document.getElementById('latest-time');
    const tempDhtEl = document.getElementById('temp-dht');
    const humEl = document.getElementById('hum');
    const presEl = document.getElementById('pres');
    const gasEl = document.getElementById('gas');
    const logBody = document.getElementById('log-table-body');

    fbUrlEl.textContent = firebaseConfig.databaseURL || '—';

    // Update connection status
    function updateStatus(status, isConnected) {
      statusText.textContent = status;
      statusIndicator.className = 'status-indicator';
      if (isConnected) {
        statusIndicator.classList.add('connected');
        dbStatusEl.textContent = 'Connected';
        dbStatusEl.style.color = '#10b981';
      } else {
        dbStatusEl.textContent = 'Disconnected';
        dbStatusEl.style.color = '#ef4444';
      }
    }

    // chart setups
    const ctxT = document.getElementById('chart-temp').getContext('2d');
    const ctxH = document.getElementById('chart-hum').getContext('2d');
    const ctxP = document.getElementById('chart-pres').getContext('2d');

    function createChartConfig(color) {
      return {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: '',
            data: [],
            borderColor: color,
            backgroundColor: color + '20',
            tension: 0.4,
            pointRadius: 0,
            borderWidth: 2,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { display: false },
            y: { 
              display: true,
              grid: { color: 'rgba(0,0,0,0.05)' }
            }
          }
        }
      };
    }

    const chartTemp = new Chart(ctxT, createChartConfig('#ef4444'));
    const chartHum = new Chart(ctxH, createChartConfig('#3b82f6'));
    const chartPres = new Chart(ctxP, createChartConfig('#10b981'));

    // helper: convert numeric string key (timestamp ms) to readable time
    function timeFromKey(k) {
      let n = Number(k);
      if (!isFinite(n)) return k;
      const d = new Date(n);
      return d.toLocaleString();
    }

    function formatTimeShort(timestamp) {
      const d = new Date(timestamp);
      return d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    }

    // Keep small rolling arrays
    const MAX_POINTS = 50;
    function pushPoint(chart, label, value) {
      chart.data.labels.push(label);
      chart.data.datasets[0].data.push(value);
      while (chart.data.labels.length > MAX_POINTS) chart.data.labels.shift();
      while (chart.data.datasets[0].data.length > MAX_POINTS) chart.data.datasets[0].data.shift();
      chart.update('none');
    }

    // Watch the last N entries under /esp32_data_log
    const logRef = query(ref(db, '/esp32_data_log'), orderByKey(), limitToLast(100));
    onValue(logRef, (snapshot) => {
      const data = snapshot.val();
      if (!data) {
        updateStatus('No data available', false);
        return;
      }
      
      updateStatus('Live updating', true);
      lastSyncEl.textContent = new Date().toLocaleTimeString();
      
      // Convert object of keys -> values into array sorted by key (ascending)
      const entries = Object.keys(data).map(k => ({ key:k, v:data[k] })).sort((a,b)=>Number(a.key)-Number(b.key));
      entryCountEl.textContent = `${entries.length} entries`;

      // Clear table body and charts
      logBody.innerHTML = '';
      // reset charts
      chartTemp.data.labels = []; chartTemp.data.datasets[0].data = [];
      chartHum.data.labels = []; chartHum.data.datasets[0].data = [];
      chartPres.data.labels = []; chartPres.data.datasets[0].data = [];

      // iterate and build rows (we will display newest first)
      for (let i = entries.length - 1; i >= 0; i--) {
        const e = entries[i];
        const val = e.v || {};
        const ts = val.timestamp_ms ? Number(val.timestamp_ms) : Number(e.key) || Date.now();
        const tr = document.createElement('tr');

        const ttime = new Date(ts).toLocaleTimeString();
        const tdTime = `<td class="small">${ttime}</td>`;
        const tdTempD = `<td>${val.temperature_dht ?? '—'}</td>`;
        const tdHum   = `<td>${val.humidity ?? '—'}</td>`;
        const tdTempB = `<td>${val.temperature_bmp ?? '—'}</td>`;
        const tdPres  = `<td>${val.pressure ?? '—'}</td>`;
        const tdGas   = `<td>${val.mq_sensor ?? '—'}</td>`;
        const tdLdr   = `<td>${val.ldr_value ?? '—'}</td>`;
        const tdRain  = `<td>${val.rain_value ?? '—'}</td>`;

        tr.innerHTML = tdTime + tdTempD + tdHum + tdTempB + tdPres + tdGas + tdLdr + tdRain;
        logBody.appendChild(tr);
      }

      // latest entry = last element in entries
      const latest = entries[entries.length - 1].v;
      const latestTime = new Date(Number(entries[entries.length - 1].key));
      latestTimeEl.textContent = `Last updated: ${latestTime.toLocaleTimeString()}`;
      
      tempDhtEl.textContent = (latest.temperature_dht !== undefined) ? latest.temperature_dht : '—';
      humEl.textContent = (latest.humidity !== undefined) ? latest.humidity : '—';
      presEl.textContent = (latest.pressure !== undefined) ? latest.pressure : '—';
      gasEl.textContent = (latest.mq_sensor !== undefined) ? latest.mq_sensor : '—';

      // Fill charts with ascending order
      for (let i = 0; i < entries.length; i++) {
        const e = entries[i];
        const val = e.v || {};
        const ts = e.key;
        const label = formatTimeShort(Number(ts));
        if (val.temperature_dht !== undefined) pushPoint(chartTemp, label, Number(val.temperature_dht));
        if (val.humidity !== undefined) pushPoint(chartHum, label, Number(val.humidity));
        if (val.pressure !== undefined) pushPoint(chartPres, label, Number(val.pressure));
      }
    }, (err) => {
      updateStatus('Connection error', false);
      console.error('Firebase error:', err);
    });

    // Initial fetch to show status
    (async () => {
      try {
        const snap = await get(ref(db, '/esp32_data_log'));
        if (!snap.exists()) {
          updateStatus('No data yet', false);
        }
      } catch(e) {
        updateStatus('Connection failed', false);
      }
    })();
  </script>
</body>
</html>

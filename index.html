#include <WiFi.h>
#include <WebServer.h>
#include <EEPROM.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>

// ================= LCD SETUP =================
LiquidCrystal_I2C lcd(0x27, 16, 2);

// ================= SENSOR PINS =================
#define PH_PIN 34
#define TDS_PIN 35

// ================= EEPROM ADDRESSES =================
#define ADDR_PH_CAL 0
#define ADDR_TDS_CAL 4

// ================= GLOBAL VARIABLES =================
float PH_CALIBRATION = 3.5;
float TDS_FACTOR = 0.5;

// ================= WIFI SETTINGS =================
const char* ssid = "FlavourSense";
const char* password = "12345678";

WebServer server(80);

// ================= FUNCTION DECLARATIONS =================
String classifyFlavour(float ph, float tds);
void handleRoot();
void handleSave();
void handleTest();
void readSensors(float &ph, float &tds, String &flavour);

// =========================================================
void setup() {
  Serial.begin(115200);
  Wire.begin(21, 22);
  lcd.init();
  lcd.backlight();
  EEPROM.begin(64);

  // Load calibration values from EEPROM
  EEPROM.get(ADDR_PH_CAL, PH_CALIBRATION);
  EEPROM.get(ADDR_TDS_CAL, TDS_FACTOR);

  if (isnan(PH_CALIBRATION) || isnan(TDS_FACTOR)) {
    PH_CALIBRATION = 3.5;
    TDS_FACTOR = 0.5;
  }

  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Flavour Sense IoT");
  lcd.setCursor(0, 1);
  lcd.print("WiFi Starting...");
  delay(2000);

  // Start WiFi Access Point
  WiFi.softAP(ssid, password);
  Serial.println();
  Serial.print("WiFi AP Started. Connect to: ");
  Serial.println(ssid);
  Serial.print("IP Address: ");
  Serial.println(WiFi.softAPIP());

  // Setup web routes
  server.on("/", handleRoot);
  server.on("/save", handleSave);
  server.on("/test", handleTest);
  server.begin();

  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("IP:");
  lcd.print(WiFi.softAPIP());
  delay(2000);
}

// =========================================================
void loop() {
  server.handleClient();

  float ph, tds;
  String flavour;
  readSensors(ph, tds, flavour);

  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("pH:");
  lcd.print(ph, 2);
  lcd.print(" T:");
  lcd.print(tds, 0);
  lcd.setCursor(0, 1);
  lcd.print("Taste:");
  lcd.print(flavour);

  delay(1500);
}

// =========================================================
void readSensors(float &ph, float &tds, String &flavour) {
  int phValue = analogRead(PH_PIN);
  int tdsValue = analogRead(TDS_PIN);

  float phVoltage = (phValue / 4095.0) * 3.3;
  float tdsVoltage = (tdsValue / 4095.0) * 3.3;

  ph = 7 + ((2.5 - phVoltage) * PH_CALIBRATION);
  tds = (tdsVoltage * 1000) * TDS_FACTOR;
  flavour = classifyFlavour(ph, tds);
}

// =========================================================
String classifyFlavour(float ph, float tds) {
  if (ph < 4.5 && tds > 300) return "Sour";
  else if (ph >= 6.5 && ph <= 7.5 && tds > 400) return "Salty";
  else if (ph > 7.5 && tds < 200) return "Bitter";
  else if (ph > 6 && tds < 100) return "Sweet";
  else if (tds > 600) return "Strong";
  else return "Neutral";
}

// =========================================================
void handleRoot() {
  float ph, tds;
  String flavour;
  readSensors(ph, tds, flavour);

  String html = R"rawliteral(
  <!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Flavour Sense IoT</title>
      <style>
          * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
          }
          
          body {
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
              background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
              min-height: 100vh;
              padding: 20px;
              color: #333;
          }
          
          .container {
              max-width: 800px;
              margin: 0 auto;
              background: rgba(255, 255, 255, 0.95);
              border-radius: 20px;
              box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
              overflow: hidden;
              backdrop-filter: blur(10px);
          }
          
          .header {
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              padding: 30px;
              text-align: center;
          }
          
          .header h1 {
              font-size: 2.5em;
              margin-bottom: 10px;
              font-weight: 300;
          }
          
          .header p {
              opacity: 0.9;
              font-size: 1.1em;
          }
          
          .content {
              padding: 40px;
          }
          
          .sensor-grid {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
              gap: 25px;
              margin-bottom: 40px;
          }
          
          .sensor-card {
              background: white;
              padding: 25px;
              border-radius: 15px;
              box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
              text-align: center;
              border-left: 4px solid #667eea;
              transition: transform 0.3s ease;
          }
          
          .sensor-card:hover {
              transform: translateY(-5px);
          }
          
          .sensor-card h3 {
              color: #667eea;
              margin-bottom: 15px;
              font-weight: 500;
          }
          
          .sensor-value {
              font-size: 2.2em;
              font-weight: 300;
              color: #333;
          }
          
          .sensor-unit {
              color: #666;
              font-size: 0.9em;
              margin-left: 5px;
          }
          
          .flavour-card {
              background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
              color: white;
              padding: 30px;
              border-radius: 15px;
              text-align: center;
              margin-bottom: 40px;
              box-shadow: 0 8px 25px rgba(255, 154, 158, 0.3);
          }
          
          .flavour-card h3 {
              margin-bottom: 15px;
              font-weight: 400;
          }
          
          .flavour-value {
              font-size: 2.5em;
              font-weight: 300;
              text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          }
          
          .action-buttons {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 15px;
              margin-bottom: 30px;
          }
          
          .btn {
              padding: 15px 25px;
              border: none;
              border-radius: 10px;
              font-size: 16px;
              font-weight: 500;
              cursor: pointer;
              transition: all 0.3s ease;
              text-decoration: none;
              text-align: center;
              display: inline-block;
          }
          
          .btn-test {
              background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
              color: white;
          }
          
          .btn-test:hover {
              transform: translateY(-2px);
              box-shadow: 0 8px 20px rgba(78, 205, 196, 0.4);
          }
          
          .btn-calibrate {
              background: linear-gradient(135deg, #FFB347 0%, #FFCC33 100%);
              color: white;
          }
          
          .btn-calibrate:hover {
              transform: translateY(-2px);
              box-shadow: 0 8px 20px rgba(255, 179, 71, 0.4);
          }
          
          .calibration-form {
              background: white;
              padding: 30px;
              border-radius: 15px;
              box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
          }
          
          .calibration-form h3 {
              color: #667eea;
              margin-bottom: 25px;
              font-weight: 500;
          }
          
          .form-group {
              margin-bottom: 20px;
          }
          
          .form-group label {
              display: block;
              margin-bottom: 8px;
              color: #555;
              font-weight: 500;
          }
          
          .form-group input {
              width: 100%;
              padding: 12px 15px;
              border: 2px solid #e1e5ee;
              border-radius: 10px;
              font-size: 16px;
              transition: border-color 0.3s ease;
              background: #f8f9fa;
          }
          
          .form-group input:focus {
              outline: none;
              border-color: #667eea;
              background: white;
          }
          
          .btn-submit {
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              border: none;
              padding: 15px 30px;
              border-radius: 10px;
              font-size: 16px;
              cursor: pointer;
              transition: transform 0.3s ease, box-shadow 0.3s ease;
              font-weight: 500;
              width: 100%;
          }
          
          .btn-submit:hover {
              transform: translateY(-2px);
              box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
          }
          
          .footer {
              text-align: center;
              margin-top: 30px;
              color: #666;
              font-size: 0.9em;
          }
          
          @media (max-width: 600px) {
              .content {
                  padding: 20px;
              }
              
              .header h1 {
                  font-size: 2em;
              }
              
              .sensor-grid {
                  grid-template-columns: 1fr;
              }
              
              .action-buttons {
                  grid-template-columns: 1fr;
              }
          }
      </style>
  </head>
  <body>
      <div class="container">
          <div class="header">
              <h1>🍽️ Flavour Sense IoT</h1>
              <p>Real-time Taste Analysis System</p>
          </div>
          
          <div class="content">
              <div class="sensor-grid">
                  <div class="sensor-card">
                      <h3>pH Level</h3>
                      <div class="sensor-value">)rawliteral";
  html += String(ph, 2);
  html += R"rawliteral(<span class="sensor-unit">pH</span></div>
                  </div>
                  
                  <div class="sensor-card">
                      <h3>TDS Value</h3>
                      <div class="sensor-value">)rawliteral";
  html += String(tds, 0);
  html += R"rawliteral(<span class="sensor-unit">ppm</span></div>
                  </div>
              </div>
              
              <div class="flavour-card">
                  <h3>Detected Flavour Profile</h3>
                  <div class="flavour-value">)rawliteral";
  html += flavour;
  html += R"rawliteral(</div>
              </div>
              
              <div class="action-buttons">
                  <a href="/test" class="btn btn-test">🧪 Run Test</a>
                  <a href="#calibration" class="btn btn-calibrate">⚙️ Calibrate Sensors</a>
              </div>
              
              <div class="calibration-form" id="calibration">
                  <h3>⚙️ Sensor Calibration</h3>
                  <form action='/save' method='GET'>
                      <div class="form-group">
                          <label for="ph">pH Calibration Factor:</label>
                          <input type='number' step='0.01' name='ph' id='ph' value=')rawliteral";
  html += String(PH_CALIBRATION, 2);
  html += R"rawliteral('>
                      </div>
                      
                      <div class="form-group">
                          <label for="tds">TDS Calibration Factor:</label>
                          <input type='number' step='0.01' name='tds' id='tds' value=')rawliteral";
  html += String(TDS_FACTOR, 2);
  html += R"rawliteral('>
                      </div>
                      
                      <button type="submit" class="btn-submit">💾 Save Calibration</button>
                  </form>
              </div>
              
              <div class="footer">
                  <p>ESP32 IoT System • IP: )rawliteral";
  html += WiFi.softAPIP().toString();
  html += R"rawliteral(</p>
              </div>
          </div>
      </div>
  </body>
  </html>
  )rawliteral";

  server.send(200, "text/html", html);
}

// =========================================================
void handleTest() {
  float ph, tds;
  String flavour;
  readSensors(ph, tds, flavour);

  String html = R"rawliteral(
  <!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Test Results - Flavour Sense IoT</title>
      <style>
          * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
          }
          
          body {
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
              background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
              min-height: 100vh;
              padding: 20px;
              color: #333;
              display: flex;
              justify-content: center;
              align-items: center;
          }
          
          .test-container {
              max-width: 600px;
              width: 100%;
              background: rgba(255, 255, 255, 0.95);
              border-radius: 20px;
              box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
              overflow: hidden;
              backdrop-filter: blur(10px);
          }
          
          .test-header {
              background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
              color: white;
              padding: 30px;
              text-align: center;
          }
          
          .test-header h1 {
              font-size: 2.2em;
              margin-bottom: 10px;
              font-weight: 300;
          }
          
          .test-content {
              padding: 40px;
              text-align: center;
          }
          
          .test-icon {
              font-size: 4em;
              margin-bottom: 20px;
          }
          
          .test-results {
              background: white;
              padding: 25px;
              border-radius: 15px;
              box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
              margin-bottom: 30px;
          }
          
          .result-item {
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 15px 0;
              border-bottom: 1px solid #f0f0f0;
          }
          
          .result-item:last-child {
              border-bottom: none;
          }
          
          .result-label {
              font-weight: 500;
              color: #555;
          }
          
          .result-value {
              font-size: 1.3em;
              font-weight: 600;
              color: #333;
          }
          
          .flavour-result {
              background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
              color: white;
              padding: 25px;
              border-radius: 15px;
              margin: 25px 0;
              box-shadow: 0 8px 25px rgba(255, 154, 158, 0.3);
          }
          
          .flavour-label {
              font-size: 1.1em;
              margin-bottom: 10px;
              opacity: 0.9;
          }
          
          .flavour-value {
              font-size: 2.2em;
              font-weight: 300;
          }
          
          .action-buttons {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 15px;
              margin-top: 30px;
          }
          
          .btn {
              padding: 15px 25px;
              border: none;
              border-radius: 10px;
              font-size: 16px;
              font-weight: 500;
              cursor: pointer;
              transition: all 0.3s ease;
              text-decoration: none;
              text-align: center;
              display: inline-block;
          }
          
          .btn-primary {
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
          }
          
          .btn-primary:hover {
              transform: translateY(-2px);
              box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
          }
          
          .btn-secondary {
              background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
              color: white;
          }
          
          .btn-secondary:hover {
              transform: translateY(-2px);
              box-shadow: 0 8px 20px rgba(78, 205, 196, 0.4);
          }
          
          .test-timestamp {
              color: #666;
              font-size: 0.9em;
              margin-top: 20px;
          }
      </style>
  </head>
  <body>
      <div class="test-container">
          <div class="test-header">
              <h1>🧪 Test Results</h1>
              <p>Current Sensor Readings</p>
          </div>
          
          <div class="test-content">
              <div class="test-icon">🔍</div>
              
              <div class="test-results">
                  <div class="result-item">
                      <span class="result-label">pH Level:</span>
                      <span class="result-value">)rawliteral";
  html += String(ph, 2);
  html += R"rawliteral( pH</span>
                  </div>
                  
                  <div class="result-item">
                      <span class="result-label">TDS Value:</span>
                      <span class="result-value">)rawliteral";
  html += String(tds, 0);
  html += R"rawliteral( ppm</span>
                  </div>
                  
                  <div class="result-item">
                      <span class="result-label">Raw pH Voltage:</span>
                      <span class="result-value">)rawliteral";
  html += String((analogRead(PH_PIN) / 4095.0) * 3.3, 3);
  html += R"rawliteral( V</span>
                  </div>
                  
                  <div class="result-item">
                      <span class="result-label">Raw TDS Voltage:</span>
                      <span class="result-value">)rawliteral";
  html += String((analogRead(TDS_PIN) / 4095.0) * 3.3, 3);
  html += R"rawliteral( V</span>
                  </div>
              </div>
              
              <div class="flavour-result">
                  <div class="flavour-label">Detected Flavour</div>
                  <div class="flavour-value">)rawliteral";
  html += flavour;
  html += R"rawliteral(</div>
              </div>
              
              <div class="action-buttons">
                  <a href="/" class="btn btn-primary">📊 Dashboard</a>
                  <a href="/test" class="btn btn-secondary">🔄 Test Again</a>
              </div>
              
              <div class="test-timestamp">
                  Test performed at: )rawliteral";
  
  // Add timestamp
  unsigned long currentTime = millis();
  unsigned long seconds = currentTime / 1000;
  unsigned long minutes = seconds / 60;
  unsigned long hours = minutes / 60;
  html += String(hours % 24) + ":" + String(minutes % 60) + ":" + String(seconds % 60);
  
  html += R"rawliteral(
              </div>
          </div>
      </div>
  </body>
  </html>
  )rawliteral";

  server.send(200, "text/html", html);
}

// =========================================================
void handleSave() {
  if (server.hasArg("ph") && server.hasArg("tds")) {
    PH_CALIBRATION = server.arg("ph").toFloat();
    TDS_FACTOR = server.arg("tds").toFloat();

    EEPROM.put(ADDR_PH_CAL, PH_CALIBRATION);
    EEPROM.put(ADDR_TDS_CAL, TDS_FACTOR);
    EEPROM.commit();

    String html = R"rawliteral(
    <!DOCTYPE html>
    <html>
    <head>
        <title>Calibration Saved</title>
        <style>
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                margin: 0;
            }
            .message {
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
                text-align: center;
            }
            .success {
                color: #4CAF50;
                font-size: 3em;
                margin-bottom: 20px;
            }
            .btn {
                display: inline-block;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 24px;
                text-decoration: none;
                border-radius: 10px;
                margin-top: 20px;
                transition: transform 0.3s ease;
            }
            .btn:hover {
                transform: translateY(-2px);
            }
        </style>
    </head>
    <body>
        <div class="message">
            <div class="success">✅</div>
            <h2>Calibration Saved Successfully!</h2>
            <p>New settings have been stored in EEPROM.</p>
            <a href="/" class="btn">Return to Dashboard</a>
        </div>
    </body>
    </html>
    )rawliteral";
    
    server.send(200, "text/html", html);
    Serial.println("Calibration updated and saved to EEPROM!");
  } else {
    server.send(400, "text/plain", "Missing parameters!");
  }
}#include <WiFi.h>
#include <WebServer.h>
#include <EEPROM.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>

// ================= LCD SETUP =================
LiquidCrystal_I2C lcd(0x27, 16, 2);

// ================= SENSOR PINS =================
#define PH_PIN 34
#define TDS_PIN 35

// ================= EEPROM ADDRESSES =================
#define ADDR_PH_CAL 0
#define ADDR_TDS_CAL 4

// ================= GLOBAL VARIABLES =================
float PH_CALIBRATION = 3.5;
float TDS_FACTOR = 0.5;

// ================= WIFI SETTINGS =================
const char* ssid = "FlavourSense";
const char* password = "12345678";

WebServer server(80);

// ================= FUNCTION DECLARATIONS =================
String classifyFlavour(float ph, float tds);
void handleRoot();
void handleSave();
void handleTest();
void readSensors(float &ph, float &tds, String &flavour);

// =========================================================
void setup() {
  Serial.begin(115200);
  Wire.begin(21, 22);
  lcd.init();
  lcd.backlight();
  EEPROM.begin(64);

  // Load calibration values from EEPROM
  EEPROM.get(ADDR_PH_CAL, PH_CALIBRATION);
  EEPROM.get(ADDR_TDS_CAL, TDS_FACTOR);

  if (isnan(PH_CALIBRATION) || isnan(TDS_FACTOR)) {
    PH_CALIBRATION = 3.5;
    TDS_FACTOR = 0.5;
  }

  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Flavour Sense IoT");
  lcd.setCursor(0, 1);
  lcd.print("WiFi Starting...");
  delay(2000);

  // Start WiFi Access Point
  WiFi.softAP(ssid, password);
  Serial.println();
  Serial.print("WiFi AP Started. Connect to: ");
  Serial.println(ssid);
  Serial.print("IP Address: ");
  Serial.println(WiFi.softAPIP());

  // Setup web routes
  server.on("/", handleRoot);
  server.on("/save", handleSave);
  server.on("/test", handleTest);
  server.begin();

  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("IP:");
  lcd.print(WiFi.softAPIP());
  delay(2000);
}

// =========================================================
void loop() {
  server.handleClient();

  float ph, tds;
  String flavour;
  readSensors(ph, tds, flavour);

  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("pH:");
  lcd.print(ph, 2);
  lcd.print(" T:");
  lcd.print(tds, 0);
  lcd.setCursor(0, 1);
  lcd.print("Taste:");
  lcd.print(flavour);

  delay(1500);
}

// =========================================================
void readSensors(float &ph, float &tds, String &flavour) {
  int phValue = analogRead(PH_PIN);
  int tdsValue = analogRead(TDS_PIN);

  float phVoltage = (phValue / 4095.0) * 3.3;
  float tdsVoltage = (tdsValue / 4095.0) * 3.3;

  ph = 7 + ((2.5 - phVoltage) * PH_CALIBRATION);
  tds = (tdsVoltage * 1000) * TDS_FACTOR;
  flavour = classifyFlavour(ph, tds);
}

// =========================================================
String classifyFlavour(float ph, float tds) {
  if (ph < 4.5 && tds > 300) return "Sour";
  else if (ph >= 6.5 && ph <= 7.5 && tds > 400) return "Salty";
  else if (ph > 7.5 && tds < 200) return "Bitter";
  else if (ph > 6 && tds < 100) return "Sweet";
  else if (tds > 600) return "Strong";
  else return "Neutral";
}

// =========================================================
void handleRoot() {
  float ph, tds;
  String flavour;
  readSensors(ph, tds, flavour);

  String html = R"rawliteral(
  <!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Flavour Sense IoT</title>
      <style>
          * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
          }
          
          body {
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
              background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
              min-height: 100vh;
              padding: 20px;
              color: #333;
          }
          
          .container {
              max-width: 800px;
              margin: 0 auto;
              background: rgba(255, 255, 255, 0.95);
              border-radius: 20px;
              box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
              overflow: hidden;
              backdrop-filter: blur(10px);
          }
          
          .header {
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              padding: 30px;
              text-align: center;
          }
          
          .header h1 {
              font-size: 2.5em;
              margin-bottom: 10px;
              font-weight: 300;
          }
          
          .header p {
              opacity: 0.9;
              font-size: 1.1em;
          }
          
          .content {
              padding: 40px;
          }
          
          .sensor-grid {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
              gap: 25px;
              margin-bottom: 40px;
          }
          
          .sensor-card {
              background: white;
              padding: 25px;
              border-radius: 15px;
              box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
              text-align: center;
              border-left: 4px solid #667eea;
              transition: transform 0.3s ease;
          }
          
          .sensor-card:hover {
              transform: translateY(-5px);
          }
          
          .sensor-card h3 {
              color: #667eea;
              margin-bottom: 15px;
              font-weight: 500;
          }
          
          .sensor-value {
              font-size: 2.2em;
              font-weight: 300;
              color: #333;
          }
          
          .sensor-unit {
              color: #666;
              font-size: 0.9em;
              margin-left: 5px;
          }
          
          .flavour-card {
              background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
              color: white;
              padding: 30px;
              border-radius: 15px;
              text-align: center;
              margin-bottom: 40px;
              box-shadow: 0 8px 25px rgba(255, 154, 158, 0.3);
          }
          
          .flavour-card h3 {
              margin-bottom: 15px;
              font-weight: 400;
          }
          
          .flavour-value {
              font-size: 2.5em;
              font-weight: 300;
              text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          }
          
          .action-buttons {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 15px;
              margin-bottom: 30px;
          }
          
          .btn {
              padding: 15px 25px;
              border: none;
              border-radius: 10px;
              font-size: 16px;
              font-weight: 500;
              cursor: pointer;
              transition: all 0.3s ease;
              text-decoration: none;
              text-align: center;
              display: inline-block;
          }
          
          .btn-test {
              background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
              color: white;
          }
          
          .btn-test:hover {
              transform: translateY(-2px);
              box-shadow: 0 8px 20px rgba(78, 205, 196, 0.4);
          }
          
          .btn-calibrate {
              background: linear-gradient(135deg, #FFB347 0%, #FFCC33 100%);
              color: white;
          }
          
          .btn-calibrate:hover {
              transform: translateY(-2px);
              box-shadow: 0 8px 20px rgba(255, 179, 71, 0.4);
          }
          
          .calibration-form {
              background: white;
              padding: 30px;
              border-radius: 15px;
              box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
          }
          
          .calibration-form h3 {
              color: #667eea;
              margin-bottom: 25px;
              font-weight: 500;
          }
          
          .form-group {
              margin-bottom: 20px;
          }
          
          .form-group label {
              display: block;
              margin-bottom: 8px;
              color: #555;
              font-weight: 500;
          }
          
          .form-group input {
              width: 100%;
              padding: 12px 15px;
              border: 2px solid #e1e5ee;
              border-radius: 10px;
              font-size: 16px;
              transition: border-color 0.3s ease;
              background: #f8f9fa;
          }
          
          .form-group input:focus {
              outline: none;
              border-color: #667eea;
              background: white;
          }
          
          .btn-submit {
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              border: none;
              padding: 15px 30px;
              border-radius: 10px;
              font-size: 16px;
              cursor: pointer;
              transition: transform 0.3s ease, box-shadow 0.3s ease;
              font-weight: 500;
              width: 100%;
          }
          
          .btn-submit:hover {
              transform: translateY(-2px);
              box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
          }
          
          .footer {
              text-align: center;
              margin-top: 30px;
              color: #666;
              font-size: 0.9em;
          }
          
          @media (max-width: 600px) {
              .content {
                  padding: 20px;
              }
              
              .header h1 {
                  font-size: 2em;
              }
              
              .sensor-grid {
                  grid-template-columns: 1fr;
              }
              
              .action-buttons {
                  grid-template-columns: 1fr;
              }
          }
      </style>
  </head>
  <body>
      <div class="container">
          <div class="header">
              <h1>🍽️ Flavour Sense IoT</h1>
              <p>Real-time Taste Analysis System</p>
          </div>
          
          <div class="content">
              <div class="sensor-grid">
                  <div class="sensor-card">
                      <h3>pH Level</h3>
                      <div class="sensor-value">)rawliteral";
  html += String(ph, 2);
  html += R"rawliteral(<span class="sensor-unit">pH</span></div>
                  </div>
                  
                  <div class="sensor-card">
                      <h3>TDS Value</h3>
                      <div class="sensor-value">)rawliteral";
  html += String(tds, 0);
  html += R"rawliteral(<span class="sensor-unit">ppm</span></div>
                  </div>
              </div>
              
              <div class="flavour-card">
                  <h3>Detected Flavour Profile</h3>
                  <div class="flavour-value">)rawliteral";
  html += flavour;
  html += R"rawliteral(</div>
              </div>
              
              <div class="action-buttons">
                  <a href="/test" class="btn btn-test">🧪 Run Test</a>
                  <a href="#calibration" class="btn btn-calibrate">⚙️ Calibrate Sensors</a>
              </div>
              
              <div class="calibration-form" id="calibration">
                  <h3>⚙️ Sensor Calibration</h3>
                  <form action='/save' method='GET'>
                      <div class="form-group">
                          <label for="ph">pH Calibration Factor:</label>
                          <input type='number' step='0.01' name='ph' id='ph' value=')rawliteral";
  html += String(PH_CALIBRATION, 2);
  html += R"rawliteral('>
                      </div>
                      
                      <div class="form-group">
                          <label for="tds">TDS Calibration Factor:</label>
                          <input type='number' step='0.01' name='tds' id='tds' value=')rawliteral";
  html += String(TDS_FACTOR, 2);
  html += R"rawliteral('>
                      </div>
                      
                      <button type="submit" class="btn-submit">💾 Save Calibration</button>
                  </form>
              </div>
              
              <div class="footer">
                  <p>ESP32 IoT System • IP: )rawliteral";
  html += WiFi.softAPIP().toString();
  html += R"rawliteral(</p>
              </div>
          </div>
      </div>
  </body>
  </html>
  )rawliteral";

  server.send(200, "text/html", html);
}

// =========================================================
void handleTest() {
  float ph, tds;
  String flavour;
  readSensors(ph, tds, flavour);

  String html = R"rawliteral(
  <!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Test Results - Flavour Sense IoT</title>
      <style>
          * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
          }
          
          body {
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
              background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
              min-height: 100vh;
              padding: 20px;
              color: #333;
              display: flex;
              justify-content: center;
              align-items: center;
          }
          
          .test-container {
              max-width: 600px;
              width: 100%;
              background: rgba(255, 255, 255, 0.95);
              border-radius: 20px;
              box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
              overflow: hidden;
              backdrop-filter: blur(10px);
          }
          
          .test-header {
              background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
              color: white;
              padding: 30px;
              text-align: center;
          }
          
          .test-header h1 {
              font-size: 2.2em;
              margin-bottom: 10px;
              font-weight: 300;
          }
          
          .test-content {
              padding: 40px;
              text-align: center;
          }
          
          .test-icon {
              font-size: 4em;
              margin-bottom: 20px;
          }
          
          .test-results {
              background: white;
              padding: 25px;
              border-radius: 15px;
              box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
              margin-bottom: 30px;
          }
          
          .result-item {
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 15px 0;
              border-bottom: 1px solid #f0f0f0;
          }
          
          .result-item:last-child {
              border-bottom: none;
          }
          
          .result-label {
              font-weight: 500;
              color: #555;
          }
          
          .result-value {
              font-size: 1.3em;
              font-weight: 600;
              color: #333;
          }
          
          .flavour-result {
              background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
              color: white;
              padding: 25px;
              border-radius: 15px;
              margin: 25px 0;
              box-shadow: 0 8px 25px rgba(255, 154, 158, 0.3);
          }
          
          .flavour-label {
              font-size: 1.1em;
              margin-bottom: 10px;
              opacity: 0.9;
          }
          
          .flavour-value {
              font-size: 2.2em;
              font-weight: 300;
          }
          
          .action-buttons {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 15px;
              margin-top: 30px;
          }
          
          .btn {
              padding: 15px 25px;
              border: none;
              border-radius: 10px;
              font-size: 16px;
              font-weight: 500;
              cursor: pointer;
              transition: all 0.3s ease;
              text-decoration: none;
              text-align: center;
              display: inline-block;
          }
          
          .btn-primary {
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
          }
          
          .btn-primary:hover {
              transform: translateY(-2px);
              box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
          }
          
          .btn-secondary {
              background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
              color: white;
          }
          
          .btn-secondary:hover {
              transform: translateY(-2px);
              box-shadow: 0 8px 20px rgba(78, 205, 196, 0.4);
          }
          
          .test-timestamp {
              color: #666;
              font-size: 0.9em;
              margin-top: 20px;
          }
      </style>
  </head>
  <body>
      <div class="test-container">
          <div class="test-header">
              <h1>🧪 Test Results</h1>
              <p>Current Sensor Readings</p>
          </div>
          
          <div class="test-content">
              <div class="test-icon">🔍</div>
              
              <div class="test-results">
                  <div class="result-item">
                      <span class="result-label">pH Level:</span>
                      <span class="result-value">)rawliteral";
  html += String(ph, 2);
  html += R"rawliteral( pH</span>
                  </div>
                  
                  <div class="result-item">
                      <span class="result-label">TDS Value:</span>
                      <span class="result-value">)rawliteral";
  html += String(tds, 0);
  html += R"rawliteral( ppm</span>
                  </div>
                  
                  <div class="result-item">
                      <span class="result-label">Raw pH Voltage:</span>
                      <span class="result-value">)rawliteral";
  html += String((analogRead(PH_PIN) / 4095.0) * 3.3, 3);
  html += R"rawliteral( V</span>
                  </div>
                  
                  <div class="result-item">
                      <span class="result-label">Raw TDS Voltage:</span>
                      <span class="result-value">)rawliteral";
  html += String((analogRead(TDS_PIN) / 4095.0) * 3.3, 3);
  html += R"rawliteral( V</span>
                  </div>
              </div>
              
              <div class="flavour-result">
                  <div class="flavour-label">Detected Flavour</div>
                  <div class="flavour-value">)rawliteral";
  html += flavour;
  html += R"rawliteral(</div>
              </div>
              
              <div class="action-buttons">
                  <a href="/" class="btn btn-primary">📊 Dashboard</a>
                  <a href="/test" class="btn btn-secondary">🔄 Test Again</a>
              </div>
              
              <div class="test-timestamp">
                  Test performed at: )rawliteral";
  
  // Add timestamp
  unsigned long currentTime = millis();
  unsigned long seconds = currentTime / 1000;
  unsigned long minutes = seconds / 60;
  unsigned long hours = minutes / 60;
  html += String(hours % 24) + ":" + String(minutes % 60) + ":" + String(seconds % 60);
  
  html += R"rawliteral(
              </div>
          </div>
      </div>
  </body>
  </html>
  )rawliteral";

  server.send(200, "text/html", html);
}

// =========================================================
void handleSave() {
  if (server.hasArg("ph") && server.hasArg("tds")) {
    PH_CALIBRATION = server.arg("ph").toFloat();
    TDS_FACTOR = server.arg("tds").toFloat();

    EEPROM.put(ADDR_PH_CAL, PH_CALIBRATION);
    EEPROM.put(ADDR_TDS_CAL, TDS_FACTOR);
    EEPROM.commit();

    String html = R"rawliteral(
    <!DOCTYPE html>
    <html>
    <head>
        <title>Calibration Saved</title>
        <style>
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                margin: 0;
            }
            .message {
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
                text-align: center;
            }
            .success {
                color: #4CAF50;
                font-size: 3em;
                margin-bottom: 20px;
            }
            .btn {
                display: inline-block;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 24px;
                text-decoration: none;
                border-radius: 10px;
                margin-top: 20px;
                transition: transform 0.3s ease;
            }
            .btn:hover {
                transform: translateY(-2px);
            }
        </style>
    </head>
    <body>
        <div class="message">
            <div class="success">✅</div>
            <h2>Calibration Saved Successfully!</h2>
            <p>New settings have been stored in EEPROM.</p>
            <a href="/" class="btn">Return to Dashboard</a>
        </div>
    </body>
    </html>
    )rawliteral";
    
    server.send(200, "text/html", html);
    Serial.println("Calibration updated and saved to EEPROM!");
  } else {
    server.send(400, "text/plain", "Missing parameters!");
  }
}

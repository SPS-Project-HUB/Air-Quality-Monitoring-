<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESP32 Air Quality — Live Dashboard</title>
  <style>
    :root {
      --primary: #3B82F6;
      --primary-dark: #2563EB;
      --secondary: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      --dark: #1E293B;
      --light: #F8FAFC;
      --gray: #64748B;
      --gray-light: #E2E8F0;
      --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #F1F5F9 0%, #E2E8F0 100%);
      color: var(--dark);
      line-height: 1.5;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding: 16px 24px;
      background: white;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    h1 {
      margin: 0;
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--dark);
    }

    .subtitle {
      color: var(--gray);
      font-size: 0.9rem;
      margin-top: 4px;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--light);
      padding: 8px 16px;
      border-radius: 50px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--gray);
    }

    .status-indicator.connected {
      background: var(--secondary);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 20px;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      box-shadow: var(--card-shadow-hover);
      transform: translateY(-2px);
    }

    .card-title {
      margin: 0 0 16px 0;
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .cards-row {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }

    .stat {
      flex: 1;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      background: var(--light);
      border-left: 4px solid var(--primary);
    }

    .stat h3 {
      margin: 0;
      font-size: 0.875rem;
      color: var(--gray);
      font-weight: 500;
    }

    .stat p {
      margin: 8px 0 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--dark);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    th, td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--gray-light);
      text-align: left;
    }

    th {
      font-size: 0.8rem;
      color: var(--gray);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background: #F8FAFC;
    }

    .small {
      font-size: 0.8rem;
      color: var(--gray);
    }

    canvas {
      max-width: 100%;
      height: 160px;
    }

    footer {
      margin-top: 24px;
      text-align: center;
      padding: 16px;
      font-size: 0.875rem;
      color: var(--gray);
    }

    .muted {
      color: var(--gray);
      font-size: 0.85rem;
    }

    .metric-highlight {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .metric-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
    }

    .metric-label {
      font-size: 0.9rem;
      color: var(--gray);
    }

    .chart-container {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
    }

    .chart-card {
      padding: 16px;
      border-radius: 12px;
      background: white;
    }

    .chart-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin: 0 0 12px 0;
      text-align: center;
      color: var(--dark);
    }

    .info-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .info-list li {
      padding: 12px 0;
      border-bottom: 1px solid var(--gray-light);
    }

    .info-list li:last-child {
      border-bottom: none;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-primary {
      background: #DBEAFE;
      color: var(--primary);
    }

    .badge-success {
      background: #D1FAE5;
      color: #065F46;
    }

    /* Responsive adjustments */
    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .chart-container {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .cards-row {
        flex-direction: column;
      }
      
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .status-badge {
        align-self: flex-end;
      }
    }
  </style>
  <!-- Chart.js (for charts) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-title">
        <div class="logo">AQ</div>
        <div>
          <h1>ESP32 Air Quality Dashboard</h1>
          <div class="subtitle">Real-time environmental monitoring from Firebase</div>
        </div>
      </div>
      <div class="status-badge">
        <div class="status-indicator" id="status-indicator"></div>
        <span id="status">Connecting...</span>
      </div>
    </header>

    <div class="grid">
      <!-- Left: main content -->
      <div>
        <div class="card">
          <div class="metric-highlight">
            <div>
              <h2 id="latest-title" style="margin:0 0 4px 0;">Latest Reading</h2>
              <div class="small" id="latest-time">—</div>
            </div>
            <div style="text-align:right">
              <div class="small">Total Entries</div>
              <div id="entry-count" style="font-weight:700; font-size:1.5rem;">0</div>
            </div>
          </div>

          <div class="cards-row" style="margin-top:20px;">
            <div class="stat">
              <h3>Temperature (DHT)</h3>
              <p id="temp-dht">— °C</p>
            </div>
            <div class="stat">
              <h3>Humidity</h3>
              <p id="hum">— %</p>
            </div>
            <div class="stat">
              <h3>Pressure (BMP)</h3>
              <p id="pres">— hPa</p>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:20px;">
          <h3 class="card-title">
            Recent Logs
            <span class="badge badge-primary" id="table-count">0 records</span>
          </h3>
          <div style="max-height:340px; overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Temp(DHT)</th>
                  <th>Humidity</th>
                  <th>Temp(BMP)</th>
                  <th>Pressure</th>
                  <th>Gas</th>
                  <th>Light</th>
                  <th>Rain</th>
                </tr>
              </thead>
              <tbody id="log-table-body">
                <tr><td colspan="8" class="small" style="text-align:center; padding: 20px;">Waiting for data…</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:20px;">
          <h3 class="card-title">Trends (Last 50 Samples)</h3>
          <div class="chart-container">
            <div class="chart-card">
              <div class="chart-title">Temperature</div>
              <canvas id="chart-temp"></canvas>
            </div>
            <div class="chart-card">
              <div class="chart-title">Humidity</div>
              <canvas id="chart-hum"></canvas>
            </div>
            <div class="chart-card">
              <div class="chart-title">Pressure</div>
              <canvas id="chart-pres"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: side panel -->
      <aside>
        <div class="card">
          <h3 class="card-title">Connection Status</h3>
          <div class="small">Firebase Project</div>
          <div id="fb-url" class="small" style="word-break:break-all; margin-bottom:12px;"></div>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span class="small">Database:</span>
            <span id="db-status" class="badge" style="background: #FEF3C7; color: #92400E;">Checking</span>
          </div>
          
          <div style="display: flex; justify-content: space-between;">
            <span class="small">Last Update:</span>
            <span id="last-update" class="small">—</span>
          </div>
        </div>

        <div class="card" style="margin-top:20px;">
          <h3 class="card-title">Sensor Status</h3>
          <ul class="info-list">
            <li style="display: flex; justify-content: space-between;">
              <span>DHT Sensor</span>
              <span id="dht-status" class="badge badge-success">Active</span>
            </li>
            <li style="display: flex; justify-content: space-between;">
              <span>BMP Sensor</span>
              <span id="bmp-status" class="badge badge-success">Active</span>
            </li>
            <li style="display: flex; justify-content: space-between;">
              <span>Gas Sensor</span>
              <span id="gas-status" class="badge" style="background: #FEF3C7; color: #92400E;">Unknown</span>
            </li>
            <li style="display: flex; justify-content: space-between;">
              <span>Light Sensor</span>
              <span id="light-status" class="badge" style="background: #FEF3C7; color: #92400E;">Unknown</span>
            </li>
          </ul>
        </div>

        <div class="card" style="margin-top:20px;">
          <h3 class="card-title">Quick Guide</h3>
          <ol style="padding-left: 20px; margin: 0;">
            <li class="small" style="margin-bottom: 8px;">Push sensor data to <code>/esp32_data_log/</code> from ESP32</li>
            <li class="small" style="margin-bottom: 8px;">Dashboard updates automatically in real-time</li>
            <li class="small">Deploy via GitHub Pages for public access</li>
          </ol>
        </div>
      </aside>
    </div>

    <footer>
      <div>ESP32 Air Quality Monitoring System • <span class="small">Live data from Firebase Realtime Database</span></div>
    </footer>
  </div>

  <!-- Firebase module SDK; uses your config (replace if needed) -->
  <script type="module">
    // ... (The JavaScript code remains exactly the same as in the original)
    // Only the CSS has been updated for a better design
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      query,
      orderByKey,
      limitToLast,
      onValue,
      get
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    // ---------- PASTE YOUR FIREBASE CONFIG BELOW ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCcFVfrAO-EOEqQcs3oZtJVLTgpF32uyb4",
      authDomain: "air-quality-e5e71.firebaseapp.com",
      databaseURL: "https://air-quality-e5e71-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "air-quality-e5e71",
      storageBucket: "air-quality-e5e71.firebasestorage.app",
      messagingSenderId: "833458600295",
      appId: "1:833458600295:web:99a1c59c0e3f612c73d7c2"
    };
    // -----------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // UI elements
    const fbUrlEl = document.getElementById('fb-url');
    const statusEl = document.getElementById('status');
    const statusIndicator = document.getElementById('status-indicator');
    const dbStatusEl = document.getElementById('db-status');
    const entryCountEl = document.getElementById('entry-count');
    const tableCountEl = document.getElementById('table-count');
    const latestTimeEl = document.getElementById('latest-time');
    const lastUpdateEl = document.getElementById('last-update');
    const tempDhtEl = document.getElementById('temp-dht');
    const humEl = document.getElementById('hum');
    const presEl = document.getElementById('pres');
    const logBody = document.getElementById('log-table-body');

    // Sensor status elements
    const dhtStatusEl = document.getElementById('dht-status');
    const bmpStatusEl = document.getElementById('bmp-status');
    const gasStatusEl = document.getElementById('gas-status');
    const lightStatusEl = document.getElementById('light-status');

    fbUrlEl.textContent = firebaseConfig.databaseURL || '—';

    // chart setups
    const ctxT = document.getElementById('chart-temp').getContext('2d');
    const ctxH = document.getElementById('chart-hum').getContext('2d');
    const ctxP = document.getElementById('chart-pres').getContext('2d');

    function emptyDataset(color) {
      return { 
        labels: [], 
        datasets: [{ 
          label: 'Value', 
          data: [], 
          tension: 0.4, 
          pointRadius: 2,
          borderColor: color || '#3B82F6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          borderWidth: 2,
          fill: true
        }] 
      };
    }
    
    const chartTemp = new Chart(ctxT, { 
      type: 'line', 
      data: emptyDataset('#EF4444'), 
      options: { 
        plugins: { legend: { display: false } }, 
        scales: { 
          x: { display: false, grid: { display: false } }, 
          y: { grid: { color: 'rgba(0,0,0,0.05)' } }
        },
        maintainAspectRatio: false
      } 
    });
    
    const chartHum = new Chart(ctxH, { 
      type: 'line', 
      data: emptyDataset('#10B981'), 
      options: { 
        plugins: { legend: { display: false } }, 
        scales: { 
          x: { display: false, grid: { display: false } }, 
          y: { grid: { color: 'rgba(0,0,0,0.05)' } }
        },
        maintainAspectRatio: false
      } 
    });
    
    const chartPres = new Chart(ctxP, { 
      type: 'line', 
      data: emptyDataset('#8B5CF6'), 
      options: { 
        plugins: { legend: { display: false } }, 
        scales: { 
          x: { display: false, grid: { display: false } }, 
          y: { grid: { color: 'rgba(0,0,0,0.05)' } }
        },
        maintainAspectRatio: false
      } 
    });

    // helper: convert numeric string key (timestamp ms) to readable time
    function timeFromKey(k) {
      let n = Number(k);
      if (!isFinite(n)) return k;
      const d = new Date(n);
      return d.toLocaleString();
    }

    // Keep small rolling arrays
    const MAX_POINTS = 50;
    function pushPoint(chart, label, value) {
      chart.data.labels.push(label);
      chart.data.datasets[0].data.push(value);
      while (chart.data.labels.length > MAX_POINTS) chart.data.labels.shift();
      while (chart.data.datasets[0].data.length > MAX_POINTS) chart.data.datasets[0].data.shift();
      chart.update('none');
    }

    // Update sensor status indicators
    function updateSensorStatus(latestData) {
      // DHT Status
      if (latestData.temperature_dht !== undefined && latestData.humidity !== undefined) {
        dhtStatusEl.textContent = 'Active';
        dhtStatusEl.className = 'badge badge-success';
      } else {
        dhtStatusEl.textContent = 'Inactive';
        dhtStatusEl.style.background = '#FEE2E2';
        dhtStatusEl.style.color = '#991B1B';
      }
      
      // BMP Status
      if (latestData.temperature_bmp !== undefined && latestData.pressure !== undefined) {
        bmpStatusEl.textContent = 'Active';
        bmpStatusEl.className = 'badge badge-success';
      } else {
        bmpStatusEl.textContent = 'Inactive';
        bmpStatusEl.style.background = '#FEE2E2';
        bmpStatusEl.style.color = '#991B1B';
      }
      
      // Gas Sensor Status
      if (latestData.mq_sensor !== undefined) {
        gasStatusEl.textContent = 'Active';
        gasStatusEl.className = 'badge badge-success';
      } else {
        gasStatusEl.textContent = 'No Data';
        gasStatusEl.style.background = '#FEF3C7';
        gasStatusEl.style.color = '#92400E';
      }
      
      // Light Sensor Status
      if (latestData.ldr_value !== undefined) {
        lightStatusEl.textContent = 'Active';
        lightStatusEl.className = 'badge badge-success';
      } else {
        lightStatusEl.textContent = 'No Data';
        lightStatusEl.style.background = '#FEF3C7';
        lightStatusEl.style.color = '#92400E';
      }
    }

    // Watch the last N entries under /esp32_data_log
    const logRef = query(ref(db, '/esp32_data_log'), orderByKey(), limitToLast(100));
    onValue(logRef, (snapshot) => {
      const data = snapshot.val();
      if (!data) {
        statusEl.textContent = 'No data';
        statusIndicator.className = 'status-indicator';
        dbStatusEl.textContent = 'No Data';
        dbStatusEl.style.background = '#FEF3C7';
        dbStatusEl.style.color = '#92400E';
        return;
      }
      
      statusEl.textContent = 'Live';
      statusIndicator.className = 'status-indicator connected';
      dbStatusEl.textContent = 'Connected';
      dbStatusEl.style.background = '#D1FAE5';
      dbStatusEl.style.color = '#065F46';
      
      // Update last update time
      lastUpdateEl.textContent = new Date().toLocaleTimeString();
      
      // Convert object of keys -> values into array sorted by key (ascending)
      const entries = Object.keys(data).map(k => ({ key:k, v:data[k] })).sort((a,b)=>Number(a.key)-Number(b.key));
      entryCountEl.textContent = entries.length;
      tableCountEl.textContent = `${entries.length} records`;

      // Clear table body and charts
      logBody.innerHTML = '';
      // reset charts
      chartTemp.data.labels = []; chartTemp.data.datasets[0].data = [];
      chartHum.data.labels = []; chartHum.data.datasets[0].data = [];
      chartPres.data.labels = []; chartPres.data.datasets[0].data = [];

      // iterate and build rows (we will display newest first)
      for (let i = entries.length - 1; i >= 0; i--) {
        const e = entries[i];
        const val = e.v || {};
        const ts = val.timestamp_ms ? Number(val.timestamp_ms) : Number(e.key) || Date.now();
        const tr = document.createElement('tr');

        const ttime = new Date(ts).toLocaleString();
        const tdTime = `<td class="small">${ttime}</td>`;
        const tdTempD = `<td>${val.temperature_dht ?? '—'}</td>`;
        const tdHum   = `<td>${val.humidity ?? '—'}</td>`;
        const tdTempB = `<td>${val.temperature_bmp ?? '—'}</td>`;
        const tdPres  = `<td>${val.pressure ?? '—'}</td>`;
        const tdGas   = `<td>${val.mq_sensor ?? '—'}</td>`;
        const tdLdr   = `<td>${val.ldr_value ?? '—'}</td>`;
        const tdRain  = `<td>${val.rain_value ?? '—'}</td>`;

        tr.innerHTML = tdTime + tdTempD + tdHum + tdTempB + tdPres + tdGas + tdLdr + tdRain;
        logBody.appendChild(tr);
      }

      // latest entry = last element in entries
      const latest = entries[entries.length - 1].v;
      latestTimeEl.textContent = timeFromKey(entries[entries.length - 1].key);
      tempDhtEl.textContent = (latest.temperature_dht !== undefined) ? `${latest.temperature_dht} °C` : '— °C';
      humEl.textContent = (latest.humidity !== undefined) ? `${latest.humidity} %` : '— %';
      presEl.textContent = (latest.pressure !== undefined) ? `${latest.pressure} hPa` : '— hPa';
      
      // Update sensor status
      updateSensorStatus(latest);

      // Fill charts with ascending order
      for (let i = 0; i < entries.length; i++) {
        const e = entries[i];
        const val = e.v || {};
        const ts = e.key;
        const label = new Date(Number(ts)).toLocaleTimeString();
        if (val.temperature_dht !== undefined) pushPoint(chartTemp, label, Number(val.temperature_dht));
        if (val.humidity !== undefined) pushPoint(chartHum, label, Number(val.humidity));
        if (val.pressure !== undefined) pushPoint(chartPres, label, Number(val.pressure));
      }
    }, (err) => {
      statusEl.textContent = 'Error: ' + err;
      statusIndicator.className = 'status-indicator';
      dbStatusEl.textContent = 'Error';
      dbStatusEl.style.background = '#FEE2E2';
      dbStatusEl.style.color = '#991B1B';
    });

    // Optional: fetch once quickly to show immediate status
    (async () => {
      try {
        const snap = await get(ref(db, '/esp32_data_log'));
        if (!snap.exists()) {
          statusEl.textContent = 'No data yet';
          statusIndicator.className = 'status-indicator';
        }
      } catch(e) {
        statusEl.textContent = 'Fetch error';
        statusIndicator.className = 'status-indicator';
      }
    })();
  </script>
</body>
</html>
